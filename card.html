import React, { useState } from 'react';
import { Plus, Trash2, Download, Upload, ChevronDown, Eye, EyeOff } from 'lucide-react';

export default function CardGameTool() {
  const [mode, setMode] = useState('deck'); // 'deck' or 'game'
  const [cardName, setCardName] = useState('');
  const [cardText, setCardText] = useState('');
  const [cards, setCards] = useState([]);
  const [deck, setDeck] = useState([]);

  // „Ç≤„Éº„É†Áî®Áä∂ÊÖã
  const [gameState, setGameState] = useState({
    library: [],
    hand: [],
    graveyard: [],
    slots: [null, null, null, null, null, null], // 0-2: „Éê„Éà„É´(Ââç), 3-5: Êéß„Åà(Âæå„Çç)
    counterCard: null,
    p1Shield: 5,
    p1HP: 5,
    p2Shield: 5,
    p2HP: 5,
    p2Slots: [null, null, null, null, null, null], // Áõ∏ÊâãÁî®
    p2CounterCard: null,
  });

  const [showLibrary, setShowLibrary] = useState(false);
  const [showGraveyard, setShowGraveyard] = useState(false);
  const [selectedCard, setSelectedCard] = useState(null);
  const [expandedCard, setExpandedCard] = useState(null);

  // ================== „Éá„ÉÉ„Ç≠ÊßãÁØâ„É¢„Éº„Éâ ==================

  const addCard = () => {
    if (cardName.trim()) {
      const newCard = {
        id: Date.now(),
        name: cardName,
        text: cardText,
      };
      setCards([...cards, newCard]);
      setCardName('');
      setCardText('');
    }
  };

  const addCardToDeck = (card) => {
    setDeck([...deck, { ...card, deckId: Date.now() + Math.random() }]);
  };

  const removeFromDeck = (deckId) => {
    setDeck(deck.filter(c => c.deckId !== deckId));
  };

  const deleteCard = (id) => {
    setCards(cards.filter(c => c.id !== id));
  };

  const saveDeck = () => {
    const deckName = prompt('„Éá„ÉÉ„Ç≠Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:') || 'deck';
    const deckData = {
      name: deckName,
      cards: deck.map(({ id, name, text }) => ({ id, name, text })),
    };
    const json = JSON.stringify(deckData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${deckName}.json`;
    a.click();
  };

  const loadDeck = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const deckData = JSON.parse(event.target.result);
          setDeck(deckData.cards.map(c => ({ ...c, deckId: Date.now() + Math.random() })));
        } catch (err) {
          alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      };
      reader.readAsText(file);
    }
  };

  const startGame = () => {
    const shuffled = [...deck].sort(() => Math.random() - 0.5);
    setGameState(prev => ({
      ...prev,
      library: shuffled.map((c, i) => ({ ...c, gameId: Date.now() + i })),
      hand: [],
      graveyard: [],
      counterZone: [],
      battleZone: [],
      controlZone: [],
    }));
    setMode('game');
  };

  // ================== „Ç≤„Éº„É†„É¢„Éº„Éâ ==================

  const drawCard = () => {
    if (gameState.library.length === 0) {
      alert('Â±±Êú≠„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
      return;
    }
    const card = gameState.library[0];
    setGameState(prev => ({
      ...prev,
      library: prev.library.slice(1),
      hand: [...prev.hand, card],
    }));
  };

  const shuffleLibrary = () => {
    setGameState(prev => ({
      ...prev,
      library: [...prev.library].sort(() => Math.random() - 0.5),
    }));
  };

  const moveToZone = (card, fromZone, toZone, slotIndex) => {
    const newCard = { ...card, hp: card.hp || 0 };

    setGameState(prev => {
      const newState = { ...prev };
      newState[fromZone] = prev[fromZone].filter(c => c && c.gameId !== card.gameId);
      const zoneCards = [...newState[toZone]];
      zoneCards[slotIndex] = newCard;
      newState[toZone] = zoneCards;
      return newState;
    });
  };

  const setCardInSlot = (card, zone, slotIndex) => {
    setGameState(prev => ({
      ...prev,
      [zone]: prev[zone].map((c, idx) => idx === slotIndex ? card : c),
    }));
  };

  const clearSlot = (zone, slotIndex) => {
    setGameState(prev => ({
      ...prev,
      [zone]: prev[zone].map((c, idx) => idx === slotIndex ? null : c),
    }));
  };

  const removeCard = (card, zone, slotIndex) => {
    if (Array.isArray(gameState[zone]) && gameState[zone][0] === null) {
      // „Çπ„É≠„ÉÉ„ÉàÂûã„ÅÆÂ†¥Âêà
      clearSlot(zone, slotIndex);
    } else {
      // „É™„Çπ„ÉàÂûã„ÅÆÂ†¥Âêà
      setGameState(prev => ({
        ...prev,
        [zone]: prev[zone].filter(c => c && c.gameId !== card.gameId),
      }));
    }
  };

  const moveCardToGraveyard = (card, zone, slotIndex) => {
    removeCard(card, zone, slotIndex);
    setGameState(prev => ({
      ...prev,
      graveyard: [...prev.graveyard, card],
    }));
  };

  const moveCardToLibrary = (card, zone, slotIndex) => {
    removeCard(card, zone, slotIndex);
    setGameState(prev => ({
      ...prev,
      library: [...prev.library, card],
    }));
  };

  const moveCardToHand = (card, zone, slotIndex) => {
    removeCard(card, zone, slotIndex);
    setGameState(prev => ({
      ...prev,
      hand: [...prev.hand, card],
    }));
  };

  const updateCardHP = (card, zone, newHP) => {
    setGameState(prev => ({
      ...prev,
      [zone]: prev[zone].map(c =>
        c.gameId === card.gameId ? { ...c, hp: Math.max(0, newHP) } : c
      ),
    }));
  };

  const CardSlot = ({ card, zone, slotIndex, canSetHP = false, canPlaceCard = false }) => {
    if (!card) {
      return (
        <div className="bg-gray-700 p-3 rounded border-2 border-dashed border-gray-600 min-h-24 flex items-center justify-center">
          <span className="text-gray-500 text-sm">„Çπ„É≠„ÉÉ„Éà {slotIndex + 1}</span>
        </div>
      );
    }

    return (
      <div className="bg-gray-700 p-2 rounded text-xs relative group">
        <p className="font-semibold truncate">{card.name}</p>
        <p className="text-gray-300 line-clamp-2 text-xs">{card.text}</p>
        {canSetHP && (
          <div className="mt-1 flex items-center gap-1">
            <span className="text-red-400">HP:</span>
            <input
              type="number"
              value={card.hp || 0}
              onChange={(e) => setCardInSlot({ ...card, hp: Math.max(0, parseInt(e.target.value) || 0) }, zone, slotIndex)}
              min="0"
              max="500"
              className="w-10 px-1 bg-gray-600 border border-gray-500 rounded text-white text-xs"
            />
          </div>
        )}
        <div className="mt-1 flex gap-1 text-xs opacity-0 group-hover:opacity-100 transition">
          <button onClick={() => moveCardToGraveyard(card, zone, slotIndex)} className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded">Â¢ìÂú∞</button>
          <button onClick={() => moveCardToLibrary(card, zone, slotIndex)} className="flex-1 bg-blue-600 hover:bg-blue-700 px-1 py-0.5 rounded">Â±±Êú≠</button>
          <button onClick={() => moveCardToHand(card, zone, slotIndex)} className="flex-1 bg-green-600 hover:bg-green-700 px-1 py-0.5 rounded">ÊâãÊú≠</button>
          <button onClick={() => clearSlot(zone, slotIndex)} className="flex-1 bg-gray-600 hover:bg-gray-500 px-1 py-0.5 rounded">ÂâäÈô§</button>
        </div>
      </div>
    );
  };

  if (mode === 'deck') {
    return (
      <div className="min-h-screen bg-gray-900 text-white p-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-4xl font-bold mb-8">„Ç´„Éº„Éâ„Ç≤„Éº„É† „ÉÜ„Çπ„Éà„ÉÑ„Éº„É´</div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* „Ç´„Éº„ÉâÁÆ°ÁêÜ */}
            <div className="lg:col-span-1 bg-gray-800 p-6 rounded-lg">
              <h2 className="text-2xl font-bold mb-4">„Ç´„Éº„ÉâÁÆ°ÁêÜ</h2>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm font-semibold mb-2">„Ç´„Éº„ÉâÂêç</label>
                  <input
                    type="text"
                    value={cardName}
                    onChange={(e) => setCardName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addCard()}
                    placeholder="‰æã: „Éï„Ç°„Ç§„Ç¢„Éú„Éº„É´"
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2">„ÉÜ„Ç≠„Çπ„Éà</label>
                  <textarea
                    value={cardText}
                    onChange={(e) => setCardText(e.target.value)}
                    placeholder="„Ç´„Éº„Éâ„ÅÆÂäπÊûú„Å™„Å©"
                    rows="4"
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                  />
                </div>
                <button
                  onClick={addCard}
                  className="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold flex items-center justify-center gap-2"
                >
                  <Plus size={20} /> „Ç´„Éº„Éâ„ÇíËøΩÂä†
                </button>
              </div>

              <h3 className="text-lg font-bold mb-3">„Ç´„Éº„Éâ„É™„Çπ„ÉàÔºà{cards.length}ÊûöÔºâ</h3>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {cards.map(card => (
                  <div
                    key={card.id}
                    className="bg-gray-700 p-3 rounded cursor-pointer hover:bg-gray-600 transition flex justify-between items-start group"
                  >
                    <div onClick={() => addCardToDeck(card)} className="flex-1">
                      <p className="font-semibold text-sm">{card.name}</p>
                      <p className="text-xs text-gray-300 line-clamp-2">{card.text}</p>
                    </div>
                    <button
                      onClick={() => deleteCard(card.id)}
                      className="ml-2 text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>

            {/* „Éá„ÉÉ„Ç≠ÊßãÁØâ */}
            <div className="lg:col-span-2 bg-gray-800 p-6 rounded-lg">
              <h2 className="text-2xl font-bold mb-4">„Éá„ÉÉ„Ç≠Ôºà{deck.length}ÊûöÔºâ</h2>

              <div className="flex gap-2 mb-6 flex-wrap">
                <button
                  onClick={saveDeck}
                  disabled={deck.length === 0}
                  className="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 px-4 py-2 rounded font-semibold flex items-center gap-2"
                >
                  <Download size={20} /> ‰øùÂ≠ò
                </button>
                <label className="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-semibold flex items-center gap-2 cursor-pointer">
                  <Upload size={20} /> Ë™≠„ÅøËæº„Åø
                  <input
                    type="file"
                    accept=".json"
                    onChange={loadDeck}
                    className="hidden"
                  />
                </label>
                <button
                  onClick={() => setDeck([])}
                  disabled={deck.length === 0}
                  className="bg-red-600 hover:bg-red-700 disabled:bg-gray-600 px-4 py-2 rounded font-semibold flex items-center gap-2 ml-auto"
                >
                  <Trash2 size={20} /> „É™„Çª„ÉÉ„Éà
                </button>
                <button
                  onClick={startGame}
                  disabled={deck.length === 0}
                  className="bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 px-4 py-2 rounded font-semibold"
                >
                  „Ç≤„Éº„É†ÈñãÂßã
                </button>
              </div>

              <div className="bg-gray-700 p-4 rounded max-h-96 overflow-y-auto">
                {deck.length === 0 ? (
                  <p className="text-gray-400 text-center py-8">Â∑¶„ÅÆ„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ËøΩÂä†</p>
                ) : (
                  <div className="space-y-2">
                    {deck.map((card, idx) => (
                      <div
                        key={card.deckId}
                        className="bg-gray-600 p-3 rounded flex justify-between items-start hover:bg-gray-500 group"
                      >
                        <div className="flex-1">
                          <p className="font-semibold text-sm">{idx + 1}. {card.name}</p>
                          <p className="text-xs text-gray-300">{card.text}</p>
                        </div>
                        <button
                          onClick={() => removeFromDeck(card.deckId)}
                          className="ml-2 text-red-400 hover:text-red-300"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ================== „Ç≤„Éº„É†Áõ§Èù¢ ==================

  return (
    <div className="min-h-screen bg-gray-900 text-white p-4">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-6">
          <div className="text-3xl font-bold">„Ç≤„Éº„É†Áõ§Èù¢</div>
          <button
            onClick={() => setMode('deck')}
            className="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded"
          >
            „Éá„ÉÉ„Ç≠„Å´Êàª„Çã
          </button>
        </div>

        {/* Áõ∏Êâã„ÅÆÂ†¥ */}
        <div className="bg-gray-800 p-4 rounded-lg mb-6">
          <h2 className="text-xl font-bold mb-3">Áõ∏Êâã„ÅÆÂ†¥</h2>
          <div className="flex gap-4 items-start">
            {/* Â∑¶ÂÅ¥Ôºö„Ç´„Ç¶„É≥„Çø„ÉºÔºÜÂ¢ìÂ†¥ */}
            <div className="flex flex-col gap-4">
              {/* „Ç´„Ç¶„É≥„Çø„Éº */}
              <div className="w-32 h-24 bg-blue-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between">
                <p className="text-xs font-semibold text-gray-300">„Ç´„Ç¶„É≥„Çø„Éº</p>
                {gameState.p2CounterCard ? (
                  <>
                    <p className="text-xs font-semibold truncate">{gameState.p2CounterCard.name}</p>
                    <p className="text-xs text-gray-300 line-clamp-1">{gameState.p2CounterCard.text}</p>
                    <div className="text-xs text-red-400">HP: {gameState.p2CounterCard.hp || 0}</div>
                  </>
                ) : (
                  <span className="text-gray-500 text-xs">‚Äî</span>
                )}
              </div>

              {/* Â¢ìÂú∞ */}
              <div className="bg-purple-900 border-2 border-gray-600 rounded p-3">
                <div className="flex gap-2">
                  <div>
                    <p className="text-sm font-semibold">„Ç∑„Éº„É´„Éâ</p>
                    <p className="text-lg font-bold text-yellow-400">{gameState.p2Shield}</p>
                  </div>
                  <div>
                    <p className="text-sm font-semibold">HP</p>
                    <p className="text-lg font-bold text-red-400">{gameState.p2HP}</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Âè≥ÂÅ¥Ôºö„Éê„Éà„É´ÔºÜÊéß„Åà */}
            <div className="flex flex-col gap-4">
              {/* „Éê„Éà„É´ÔºàÂâçÔºâÊ®™„Å´3„Å§ */}
              <div className="flex flex-col gap-2">
                <p className="text-xs font-semibold text-gray-400">„Éê„Éà„É´ÔºàÂâçÔºâ</p>
                <div className="flex gap-2">
                  {[0, 1, 2].map(idx => (
                    <div
                      key={`p2-battle-${idx}`}
                      className="w-28 h-24 bg-pink-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between"
                    >
                      {gameState.p2Slots[idx] ? (
                        <>
                          <p className="text-xs font-semibold truncate">{gameState.p2Slots[idx].name}</p>
                          <p className="text-xs text-gray-300 line-clamp-1">{gameState.p2Slots[idx].text}</p>
                          <div className="text-xs text-red-400">HP: {gameState.p2Slots[idx].hp || 0}</div>
                        </>
                      ) : (
                        <span className="text-gray-500 text-xs">‚Äî</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Êéß„ÅàÔºàÂæå„ÇçÔºâÊ®™„Å´3„Å§ */}
              <div className="flex flex-col gap-2">
                <p className="text-xs font-semibold text-gray-400">Êéß„ÅàÔºàÂæå„ÇçÔºâ</p>
                <div className="flex gap-2">
                  {[3, 4, 5].map(idx => (
                    <div
                      key={`p2-control-${idx}`}
                      className="w-28 h-24 bg-green-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between"
                    >
                      {gameState.p2Slots[idx] ? (
                        <>
                          <p className="text-xs font-semibold truncate">{gameState.p2Slots[idx].name}</p>
                          <p className="text-xs text-gray-300 line-clamp-1">{gameState.p2Slots[idx].text}</p>
                          <div className="text-xs text-red-400">HP: {gameState.p2Slots[idx].hp || 0}</div>
                        </>
                      ) : (
                        <span className="text-gray-500 text-xs">‚Äî</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Ëá™ÂàÜ„ÅÆÂ†¥ */}
        <div className="bg-gray-800 p-4 rounded-lg mb-6">
          <h2 className="text-xl font-bold mb-3">Ëá™ÂàÜ„ÅÆÂ†¥</h2>
          <div className="flex gap-4 items-start justify-end">
            {/* Â∑¶ÂÅ¥Ôºö„Éê„Éà„É´ÔºÜÊéß„Åà */}
            <div className="flex flex-col gap-4">
              {/* „Éê„Éà„É´ÔºàÂâçÔºâÊ®™„Å´3„Å§ */}
              <div className="flex flex-col gap-2">
                <p className="text-xs font-semibold text-gray-400">„Éê„Éà„É´ÔºàÂâçÔºâ</p>
                <div className="flex gap-2">
                  {[0, 1, 2].map(idx => (
                    <div
                      key={`p1-battle-${idx}`}
                      className="w-28 h-24 bg-pink-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between group relative"
                    >
                      {gameState.slots[idx] ? (
                        <>
                          <p className="text-xs font-semibold truncate">{gameState.slots[idx].name}</p>
                          <p className="text-xs text-gray-300 line-clamp-1">{gameState.slots[idx].text}</p>
                          <div className="flex gap-1 text-xs mt-auto">
                            <input
                              type="number"
                              value={gameState.slots[idx].hp || 0}
                              onChange={(e) => setGameState(prev => ({
                                ...prev,
                                slots: prev.slots.map((c, i) => i === idx ? { ...c, hp: Math.max(0, parseInt(e.target.value) || 0) } : c)
                              }))}
                              min="0"
                              max="500"
                              className="w-12 px-1 bg-gray-700 border border-gray-500 rounded text-white text-xs"
                            />
                            <button
                              onClick={() => setSelectedCard({ card: gameState.slots[idx], zone: 'slots', index: idx })}
                              className="flex-1 bg-yellow-600 hover:bg-yellow-700 px-1 py-0.5 rounded text-xs"
                            >
                              Áßª
                            </button>
                            <button
                              onClick={() => moveCardToGraveyard(gameState.slots[idx], 'slots', idx)}
                              className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded text-xs"
                            >
                              Â¢ì
                            </button>
                          </div>
                          {selectedCard?.zone === 'slots' && selectedCard?.index === idx && (
                            <div className="absolute top-0 right-0 bg-gray-900 border border-yellow-400 rounded p-1 text-xs space-y-1 z-10">
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 0 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´1
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 1 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´2
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 2 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´3
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 3 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà1
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 4 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà2
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 5 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà3
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    hand: [...prev.hand, selectedCard.card],
                                    slots: prev.slots.map((c, i) => i === idx ? null : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-blue-600 hover:bg-blue-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                ÊâãÊú≠„Å∏
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    library: [...prev.library, selectedCard.card],
                                    slots: prev.slots.map((c, i) => i === idx ? null : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-indigo-600 hover:bg-indigo-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Â±±Êú≠„Å∏
                              </button>
                            </div>
                          )}
                        </>
                      ) : (
                        <span className="text-gray-500 text-xs">‚Äî</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Êéß„ÅàÔºàÂæå„ÇçÔºâÊ®™„Å´3„Å§ */}
              <div className="flex flex-col gap-2">
                <p className="text-xs font-semibold text-gray-400">Êéß„ÅàÔºàÂæå„ÇçÔºâ</p>
                <div className="flex gap-2">
                  {[3, 4, 5].map(idx => (
                    <div
                      key={`p1-control-${idx}`}
                      className="w-28 h-24 bg-green-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between group relative"
                    >
                      {gameState.slots[idx] ? (
                        <>
                          <p className="text-xs font-semibold truncate">{gameState.slots[idx].name}</p>
                          <p className="text-xs text-gray-300 line-clamp-1">{gameState.slots[idx].text}</p>
                          <div className="flex gap-1 text-xs mt-auto">
                            <input
                              type="number"
                              value={gameState.slots[idx].hp || 0}
                              onChange={(e) => setGameState(prev => ({
                                ...prev,
                                slots: prev.slots.map((c, i) => i === idx ? { ...c, hp: Math.max(0, parseInt(e.target.value) || 0) } : c)
                              }))}
                              min="0"
                              max="500"
                              className="w-12 px-1 bg-gray-700 border border-gray-500 rounded text-white text-xs"
                            />
                            <button
                              onClick={() => setSelectedCard({ card: gameState.slots[idx], zone: 'slots', index: idx })}
                              className="flex-1 bg-yellow-600 hover:bg-yellow-700 px-1 py-0.5 rounded text-xs"
                            >
                              Áßª
                            </button>
                            <button
                              onClick={() => moveCardToGraveyard(gameState.slots[idx], 'slots', idx)}
                              className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded text-xs"
                            >
                              Â¢ì
                            </button>
                          </div>
                          {selectedCard?.zone === 'slots' && selectedCard?.index === idx && (
                            <div className="absolute top-0 right-0 bg-gray-900 border border-yellow-400 rounded p-1 text-xs space-y-1 z-10">
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 0 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´1
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 1 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´2
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 2 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                „Éê„Éà„É´3
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 3 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà1
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 4 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà2
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    slots: prev.slots.map((c, i) => i === 5 ? { ...selectedCard.card, hp: selectedCard.card.hp || 0 } : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Êéß„Åà3
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    hand: [...prev.hand, selectedCard.card],
                                    slots: prev.slots.map((c, i) => i === idx ? null : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-blue-600 hover:bg-blue-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                ÊâãÊú≠„Å∏
                              </button>
                              <button
                                onClick={() => {
                                  setGameState(prev => ({
                                    ...prev,
                                    library: [...prev.library, selectedCard.card],
                                    slots: prev.slots.map((c, i) => i === idx ? null : c)
                                  }));
                                  setSelectedCard(null);
                                }}
                                className="block w-full text-left bg-indigo-600 hover:bg-indigo-700 px-2 py-0.5 rounded text-xs whitespace-nowrap"
                              >
                                Â±±Êú≠„Å∏
                              </button>
                            </div>
                          )}
                        </>
                      ) : (
                        <span className="text-gray-500 text-xs">‚Äî</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Âè≥ÂÅ¥Ôºö„Çπ„ÉÜ„Éº„Çø„ÇπÔºÜ„Ç´„Ç¶„É≥„Çø„Éº */}
            <div className="flex flex-col gap-4">
              {/* „Çπ„ÉÜ„Éº„Çø„Çπ */}
              <div className="bg-purple-900 border-2 border-gray-600 rounded p-3">
                <div className="flex gap-4">
                  <div>
                    <p className="text-sm font-semibold">„Ç∑„Éº„É´„Éâ</p>
                    <input
                      type="number"
                      value={gameState.p1Shield}
                      onChange={(e) => setGameState(prev => ({ ...prev, p1Shield: Math.max(0, parseInt(e.target.value) || 0) }))}
                      min="0"
                      max="5"
                      className="w-12 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white"
                    />
                  </div>
                  <div>
                    <p className="text-sm font-semibold">„Éó„É¨„Ç§„É§„ÉºHP</p>
                    <input
                      type="number"
                      value={gameState.p1HP}
                      onChange={(e) => setGameState(prev => ({ ...prev, p1HP: Math.max(0, parseInt(e.target.value) || 0) }))}
                      min="0"
                      max="5"
                      className="w-12 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white"
                    />
                  </div>
                </div>
              </div>

              {/* „Ç´„Ç¶„É≥„Çø„Éº */}
              <div className="w-32 h-24 bg-blue-900 border-2 border-gray-600 rounded p-2 flex flex-col justify-between">
                <p className="text-xs font-semibold text-gray-300">„Ç´„Ç¶„É≥„Çø„Éº</p>
                {gameState.counterCard ? (
                  <>
                    <p className="text-xs font-semibold truncate">{gameState.counterCard.name}</p>
                    <p className="text-xs text-gray-300 line-clamp-1">{gameState.counterCard.text}</p>
                    <div className="flex gap-1 text-xs mt-auto">
                      <input
                        type="number"
                        value={gameState.counterCard.hp || 0}
                        onChange={(e) => setGameState(prev => ({
                          ...prev,
                          counterCard: { ...prev.counterCard, hp: Math.max(0, parseInt(e.target.value) || 0) }
                        }))}
                        min="0"
                        max="500"
                        className="w-12 px-1 bg-gray-700 border border-gray-500 rounded text-white text-xs"
                      />
                      <button
                        onClick={() => {
                          setGameState(prev => ({ ...prev, graveyard: [...prev.graveyard, prev.counterCard], counterCard: null }));
                        }}
                        className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded text-xs"
                      >
                        Â¢ì
                      </button>
                    </div>
                  </>
                ) : (
                  <span className="text-gray-500 text-xs">‚Äî</span>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Â±±Êú≠„ÉªÂ¢ìÂú∞„ÉªÊâãÊú≠ */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
          {/* Â±±Êú≠ */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-lg font-bold">Â±±Êú≠ ({gameState.library.length})</h3>
              <button
                onClick={shuffleLibrary}
                className="bg-blue-600 hover:bg-blue-700 px-2 py-1 text-sm rounded"
              >
                „Ç∑„É£„ÉÉ„Éï„É´
              </button>
            </div>
            <div className="flex gap-2 mb-3">
              <button
                onClick={drawCard}
                className="flex-1 bg-green-600 hover:bg-green-700 px-3 py-2 rounded font-semibold"
              >
                Âºï„Åè
              </button>
              <button
                onClick={() => setShowLibrary(!showLibrary)}
                className="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded"
              >
                {showLibrary ? <EyeOff size={18} /> : <Eye size={18} />}
              </button>
            </div>
            {showLibrary && (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {gameState.library.map((card, idx) => (
                  <div key={card.gameId} className="bg-gray-700 p-2 rounded text-xs">
                    <p className="font-semibold">{idx + 1}. {card.name}</p>
                    <p className="text-gray-300 line-clamp-2">{card.text}</p>
                    <div className="mt-1 flex gap-1 text-xs">
                      <button onClick={() => moveCardToGraveyard(card, 'library')} className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded">Â¢ìÂú∞</button>
                      <button onClick={() => moveCardToHand(card, 'library')} className="flex-1 bg-green-600 hover:bg-green-700 px-1 py-0.5 rounded">ÊâãÊú≠</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Â¢ìÂú∞ */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-lg font-bold">Â¢ìÂú∞ ({gameState.graveyard.length})</h3>
              <button
                onClick={() => setShowGraveyard(!showGraveyard)}
                className="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded"
              >
                {showGraveyard ? <EyeOff size={18} /> : <Eye size={18} />}
              </button>
            </div>
            {showGraveyard && (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {gameState.graveyard.map((card, idx) => (
                  <div key={card.gameId} className="bg-gray-700 p-2 rounded text-xs">
                    <p className="font-semibold">{idx + 1}. {card.name}</p>
                    <p className="text-gray-300 line-clamp-2">{card.text}</p>
                    <div className="mt-1 flex gap-1 text-xs">
                      <button onClick={() => moveCardToLibrary(card, 'graveyard')} className="flex-1 bg-blue-600 hover:bg-blue-700 px-1 py-0.5 rounded">Â±±Êú≠</button>
                      <button onClick={() => moveCardToHand(card, 'graveyard')} className="flex-1 bg-green-600 hover:bg-green-700 px-1 py-0.5 rounded">ÊâãÊú≠</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* ÊâãÊú≠ */}
          <div className="bg-gray-800 p-4 rounded-lg">
            <h3 className="text-lg font-bold mb-3">ÊâãÊú≠ ({gameState.hand.length})</h3>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {gameState.hand.map((card, idx) => (
                <div key={card.gameId} className="bg-gray-700 p-2 rounded text-xs group relative">
                  <div className="flex justify-between items-start gap-1">
                    <div className="flex-1">
                      <p className="font-semibold">{idx + 1}. {card.name}</p>
                      <p className="text-gray-300 line-clamp-2">{card.text}</p>
                    </div>
                    <button
                      onClick={() => setExpandedCard(expandedCard === card.gameId ? null : card.gameId)}
                      className="text-blue-400 hover:text-blue-300 flex-shrink-0"
                      title="Ë©≥Á¥∞Ë°®Á§∫"
                    >
                      üìñ
                    </button>
                  </div>

                  {expandedCard === card.gameId && (
                    <div className="mt-2 p-2 bg-gray-800 border border-blue-500 rounded text-xs whitespace-pre-wrap text-gray-200">
                      {card.text}
                    </div>
                  )}

                  <div className="mt-1 grid grid-cols-3 gap-1 text-xs">
                    {/* „Éê„Éà„É´„Çπ„É≠„ÉÉ„Éà */}
                    <div className="space-y-1">
                      <p className="text-pink-300 font-semibold text-xs">„Éê„Éà„É´</p>
                      <div className="flex gap-0.5">
                        {[0, 1, 2].map(i => (
                          <button
                            key={i}
                            onClick={() => setGameState(prev => ({
                              ...prev,
                              slots: prev.slots.map((c, idx) => idx === i ? { ...card, gameId: card.gameId, hp: card.hp || 0 } : c),
                              hand: prev.hand.filter(c => c.gameId !== card.gameId)
                            }))}
                            className="flex-1 bg-pink-600 hover:bg-pink-700 px-0.5 py-0.5 rounded text-xs"
                          >
                            {i+1}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Êéß„Åà„Çπ„É≠„ÉÉ„Éà */}
                    <div className="space-y-1">
                      <p className="text-green-300 font-semibold text-xs">Êéß„Åà</p>
                      <div className="flex gap-0.5">
                        {[3, 4, 5].map(i => (
                          <button
                            key={i}
                            onClick={() => setGameState(prev => ({
                              ...prev,
                              slots: prev.slots.map((c, idx) => idx === i ? { ...card, gameId: card.gameId, hp: card.hp || 0 } : c),
                              hand: prev.hand.filter(c => c.gameId !== card.gameId)
                            }))}
                            className="flex-1 bg-green-600 hover:bg-green-700 px-0.5 py-0.5 rounded text-xs"
                          >
                            {i-2}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* „Ç´„Ç¶„É≥„Çø„Éº */}
                    <button
                      onClick={() => setGameState(prev => ({
                        ...prev,
                        counterCard: { ...card, gameId: card.gameId, hp: card.hp || 0 },
                        hand: prev.hand.filter(c => c.gameId !== card.gameId)
                      }))}
                      className="bg-blue-600 hover:bg-blue-700 px-1 py-1 rounded text-xs"
                    >
                      „Ç´„Ç¶„É≥„Çø„Éº
                    </button>
                  </div>

                  <div className="mt-1 flex gap-1 text-xs">
                    <button
                      onClick={() => setGameState(prev => ({
                        ...prev,
                        graveyard: [...prev.graveyard, card],
                        hand: prev.hand.filter(c => c.gameId !== card.gameId)
                      }))}
                      className="flex-1 bg-red-600 hover:bg-red-700 px-1 py-0.5 rounded"
                    >
                      Â¢ìÂú∞„Å∏
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}