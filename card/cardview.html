<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒ‰ä¸€è¦§</title>
    <link rel="stylesheet" href="../css/default.css">
    <style>
        body {
            padding: 2rem;
        }

        .main-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 1.5rem;
        }

        .upload-section {
            background: var(--callout-bg);
            border: 1px solid var(--callout-border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem 2rem;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(139, 158, 125, 0.05);
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(139, 158, 125, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input[type="file"] {
            display: none;
        }

        .toolbar {
            background: var(--callout-bg);
            border: 1px solid var(--callout-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: rgba(139, 158, 125, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'MainFont', sans-serif;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: rgba(139, 158, 125, 0.2);
            border-color: var(--accent-color);
        }

        .filter-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-green);
            color: white;
        }

        .search-container {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-box input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            border-radius: 4px;
            font-family: 'MainFont', sans-serif;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .search-checkbox {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .search-checkbox input[type="checkbox"] {
            cursor: pointer;
        }

        .controls-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            border-radius: 4px;
            font-family: 'MainFont', sans-serif;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .stats {
            background: var(--callout-bg);
            border: 1px solid var(--callout-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .stat-value {
            color: var(--accent-color);
            font-size: 1.3rem;
            font-weight: bold;
        }

        .card-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .card-list.simple-mode {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .card-item {
            background: var(--callout-bg);
            border: 1px solid var(--callout-border);
            border-radius: 8px;
            /* å°‘ã—å°ã•ãã—ã¦å…¨ä½“ã®ã‚µã‚¤ã‚ºã‚’æŠ‘ãˆã‚‹ */
            padding: 0.5rem 0.8rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .card-item:hover {
            border-color: var(--accent-color);
            background: rgba(139, 158, 125, 0.15);
        }

        /* ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ */
        .card-item.simple {
            padding: 0.4rem 0.8rem;
        }
        /* è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã¯å°‘ã—å°ã•ã„ãƒ•ã‚©ãƒ³ãƒˆã« */
        .card-item.detail {
            font-size: 0.95rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .card-title-section {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            flex: 1;
            min-width: 200px;
        }

        .card-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .card-ruby {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .card-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .card-type {
            display: inline-block;
            padding: 0.25rem 0.65rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-monster { 
            background: rgba(218, 165, 32, 0.3);
            color: #daa520;
            border: 1px solid rgba(218, 165, 32, 0.5);
        }
        .type-magic { 
            background: rgba(100, 149, 237, 0.3);
            color: #6495ed;
            border: 1px solid rgba(100, 149, 237, 0.5);
        }
        .type-supporter { 
            background: rgba(144, 238, 144, 0.3);
            color: #90ee90;
            border: 1px solid rgba(144, 238, 144, 0.5);
        }
        .type-ex { 
            background: rgba(219, 112, 147, 0.3);
            color: #db7093;
            border: 1px solid rgba(219, 112, 147, 0.5);
        }

        .card-stats {
            display: flex;
            gap: 0.75rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        /* è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã§ç”»åƒã‚’è¡¨ç¤º */
        .card-item.detail .card-body {
            flex-direction: row;
            gap: 1rem;
            align-items: flex-start;
        }
        .card-item.detail .card-image {
            /* è‡ªå‹•èª¿æ•´: æœ€å°140pxã€æœ€å¤§200pxã€å¹…ã¯ãŠã‚ˆã 18% ã‚’ç›®å®‰ã« */
            width: clamp(140px, 18%, 200px);
            flex: 0 0 clamp(140px, 18%, 200px);
            max-width: 200px;
        }
        .card-item.detail .card-image img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: block;
            /* ä½™ç™½ã‚’æŠ‘ãˆãŸè¦‹ãŸç›®ã« */
            box-shadow: none;
        }
        .card-item.detail .card-details {
            flex: 1;
            min-width: 0;
        }

        .card-info-row {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .card-section {
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .card-section.full-width {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--accent-color);
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .section-content {
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .card-section.full-width .section-label {
            margin-bottom: 0.2rem;
        }

        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .skill-item {
            background: rgba(139, 158, 125, 0.1);
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .skill-header {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 0.15rem;
            font-size: 0.85rem;
        }

        .skill-text {
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid var(--callout-border);
            border-radius: 8px;
            padding: 2rem;
            /* æ¨ªå¹…ã‚’åºƒã’ã¦ã‚†ã£ãŸã‚Šè¡¨ç¤ºï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ã§æ¨ªä¸¦ã³ãŒæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«æ‹¡å¼µï¼‰ */
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* å·¦ã«å¤§ãã‚ã®ç”»åƒã€å³ã«è©³ç´°ã‚’ä¸¦ã¹ã‚‹ */
        .modal-body {
            display: flex;
            gap: 1.25rem;
            align-items: flex-start;
        }
        .modal-image {
            flex: 0 0 clamp(240px, 36%, 420px);
            max-width: 420px;
        }
        .modal-image img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: block;
            box-shadow: none;
        }
        .modal-details {
            flex: 1;
            min-width: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            gap: 1rem;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .modal-ruby {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .close-btn {
            background: var(--callout-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 1.2rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .close-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* NOTE: ä¸Šéƒ¨ã§ .modal-body ã‚’æ¨ªä¸¦ã³ã«å®šç¾©ã—ã¦ã„ã‚‹ãŸã‚ã€
           ã“ã“ã§ã®å¼·åˆ¶çš„ãªç¸¦ä¸¦ã³å®šç¾©ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚
           ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªå†…ã§ç¸¦ä¸¦ã³ã«æˆ»ã‚Šã¾ã™ã€‚ */

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .modal-section-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-section-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .modal-info-row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .modal-info-item {
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .modal-skills {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-skill-item {
            background: rgba(139, 158, 125, 0.15);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .modal-skill-name {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
        }

        .modal-skill-text {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã®ä»£æ›¿ï¼‰ */
        .mode-btn {
            padding: 0.45rem 0.85rem;
            border: 1px solid var(--border-color);
            background: rgba(139,158,125,0.08);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'MainFont', sans-serif;
            font-size: 0.9rem;
        }
        .mode-btn:hover { background: rgba(139,158,125,0.14); }
        .mode-btn.active { background: var(--accent-color); border-color: var(--accent-green); color: white; }

        @media (max-width: 768px) {
            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .modal-name {
                font-size: 1.4rem;
            }
            /* å°ç”»é¢ã§ã¯ç¸¦ä¸¦ã³ã«æˆ»ã™ */
            .modal-body {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group, .controls-row {
                justify-content: center;
            }

            .stats {
                gap: 1rem;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-body {
                grid-template-columns: 1fr;
            }

            .card-list.simple-mode {
                grid-template-columns: 1fr;
            }
            /* ãƒ¢ãƒã‚¤ãƒ«ç­‰ã§ã¯è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã¯ç¸¦ç©ã¿ã«æˆ»ã™ */
            .card-item.detail .card-body {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h1>

        <div class="upload-section" id="uploadSection">
            <label for="fileInput" class="upload-area">
                <div class="upload-icon">ğŸ´</div>
                <div class="upload-text">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <div class="upload-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
            </label>
            <input type="file" id="fileInput" accept=".json">
        </div>

        <div id="contentSection" class="hidden">
            <div class="toolbar">
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all">ALL</button>
                    <button class="filter-btn" data-filter="monster">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</button>
                    <button class="filter-btn" data-filter="magic">é­”æ³•</button>
                    <button class="filter-btn" data-filter="supporter">ã‚µãƒãƒ¼ã‚¿ãƒ¼</button>
                    <button class="filter-btn" data-filter="ex">EX</button>
                </div>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="æ¤œç´¢...">
                    </div>
                    <div class="search-options">
                        <label class="search-checkbox">
                            <input type="checkbox" id="searchName" checked>
                            <span>ã‚«ãƒ¼ãƒ‰å</span>
                        </label>
                        <label class="search-checkbox">
                            <input type="checkbox" id="searchType" checked>
                            <span>ã‚¿ã‚¤ãƒ—</span>
                        </label>
                        <label class="search-checkbox">
                            <input type="checkbox" id="searchContent" checked>
                            <span>å†…å®¹ãƒ†ã‚­ã‚¹ãƒˆ</span>
                        </label>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <label class="control-label">è¡¨ç¤º:</label>
                        <div class="view-mode-group">
                            <button class="mode-btn" data-view="simple">ã‚·ãƒ³ãƒ—ãƒ«</button>
                            <button class="mode-btn active" data-view="detail">è©³ç´°</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">ä¸¦ã³æ›¿ãˆ:</label>
                        <select id="sortSelect">
                            <option value="name">åå‰</option>
                            <option value="type">ç¨®é¡</option>
                            <option value="atk">ATK</option>
                            <option value="hp">HP</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">æ—:</label>
                        <select id="tribeSelect">
                            <option value="all">ã™ã¹ã¦</option>
                        </select>
                   </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Total</span>
                    <span class="stat-value" id="totalCards">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è¡¨ç¤ºä¸­</span>
                    <span class="stat-value" id="displayCards">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</span>
                    <span class="stat-value" id="monsterCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é­”æ³•</span>
                    <span class="stat-value" id="magicCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ã‚µãƒãƒ¼ã‚¿ãƒ¼</span>
                    <span class="stat-value" id="supporterCount">0</span>
                </div>
            </div>

            <div class="card-list" id="cardContainer"></div>
        </div>

        <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal" id="detailModal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-title-section">
                        <div class="modal-name" id="modalName"></div>
                        <div class="modal-ruby" id="modalRuby"></div>
                    </div>
                    <button class="close-btn" onclick="closeModal()">âœ•</button>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>
    </div>

    <script>
        let allCards = [];
        let filteredCards = [];
        let currentFilter = 'all';
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è©³ç´°ã«å¤‰æ›´
        let viewMode = 'detail';

        const tribeSelect = document.getElementById('tribeSelect');

        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.querySelector('.upload-area');

        // tribe dropdown change -> re-filter
        if (tribeSelect) tribeSelect.addEventListener('change', applyFilters);

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/json') {
                loadJSON(file);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) loadJSON(file);
        }

        function loadJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    setCardsFromData(data);
                } catch (error) {
                    alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function setCardsFromData(data) {
            allCards = Array.isArray(data) ? data : [data];
            updateTribeOptions();
+           updateTribeVisibility();
            // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ãªã©ã€é¸æŠä¸­ã®ç¨®åˆ¥ã«åˆã‚ã›ã¦ã‚½ãƒ¼ãƒˆã‚’æ›´æ–°
            updateSortOptions(currentFilter);
            filteredCards = [...allCards];
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('contentSection').classList.remove('hidden');
            updateStats();
            renderCards();
        }

        function updateTribeOptions() {
            if (!tribeSelect) return;
            const prev = tribeSelect.value || 'all';
            // collect unique non-empty tribes
            const tribes = Array.from(new Set(allCards.map(c => (c.tribe || '').trim()).filter(Boolean))).sort((a,b)=> a.localeCompare(b));
            tribeSelect.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
            tribes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                tribeSelect.appendChild(opt);
            });
            // restore previous selection if available
            tribeSelect.value = tribes.includes(prev) ? prev : 'all';
        }

        // ç¨®åˆ¥ãŒ magic ã¾ãŸã¯ supporter ã®ã¨ãã«ã€Œæ—ã€ãƒ•ã‚£ãƒ«ã‚¿ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        function updateTribeVisibility() {
            const group = tribeSelect ? tribeSelect.parentElement : null;
            if (!group) return;
            if (currentFilter === 'magic' || currentFilter === 'supporter') {
                group.style.display = 'none';
                tribeSelect.value = 'all';
            } else {
                group.style.display = 'flex';
            }
        }

        function autoLoadLocalJson() {
            fetch('card.json', { cache: 'no-cache' })
                .then(resp => {
                    if (!resp.ok) throw new Error('not found');
                    return resp.json();
                })
                .then(json => {
                    setCardsFromData(json);
                })
                .catch(() => {});
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                // é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã«å¿œã˜ã¦ã‚½ãƒ¼ãƒˆã‚’æ›´æ–°
                updateSortOptions(currentFilter);
+               // ã€Œæ—ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
+               updateTribeVisibility();
                applyFilters();
            });
        });

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('sortSelect').addEventListener('change', applyFilters);
        document.getElementById('searchName').addEventListener('change', applyFilters);
        document.getElementById('searchType').addEventListener('change', applyFilters);
        document.getElementById('searchContent').addEventListener('change', applyFilters);
        // view ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã®ä»£æ›¿ï¼‰
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                viewMode = btn.dataset.view;
                renderCards();
            });
        });

        // ç¨®åˆ¥ã«å¿œã˜ãŸã‚½ãƒ¼ãƒˆé¸æŠè‚¢ã®åˆ‡ã‚Šæ›¿ãˆ
        function updateSortOptions(filter) {
            const sel = document.getElementById('sortSelect');
            if (!sel) return;
            const prev = sel.value;
            if (filter === 'magic') {
                sel.innerHTML = '<option value="name">åå‰</option><option value="cost">ã‚³ã‚¹ãƒˆ</option>';
                sel.value = prev === 'cost' || prev === 'name' ? prev : 'cost';
            } else if (filter === 'supporter') {
                sel.innerHTML = '<option value="name">åå‰</option>';
                sel.value = 'name';
            } else if (filter === 'all') {
                sel.innerHTML = '<option value="name">åå‰</option><option value="type">ç¨®é¡</option>';
                sel.value = ['name','type'].includes(prev) ? prev : 'name';
            } else {
                sel.innerHTML = '<option value="name">åå‰</option><option value="type">ç¨®é¡</option><option value="atk">ATK</option><option value="hp">HP</option>';
                sel.value = ['name','type','atk','hp'].includes(prev) ? prev : 'name';
            }
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const sort = document.getElementById('sortSelect').value;
            const selectedTribe = (tribeSelect && tribeSelect.value) ? tribeSelect.value : 'all';
            const searchName = document.getElementById('searchName').checked;
            const searchType = document.getElementById('searchType').checked;
            const searchContent = document.getElementById('searchContent').checked;

            filteredCards = allCards.filter(card => {
                const matchFilter = currentFilter === 'all' || card.cardBase === currentFilter;
                const matchTribe = selectedTribe === 'all' || (card.tribe || '') === selectedTribe;
                if (!search) return matchFilter && matchTribe;

                let matchSearch = false;

                if (searchName) {
                    const name = (card.cardName || '').toLowerCase();
                    const ruby = (card.cardRuby || '').toLowerCase();
                    if (name.includes(search) || ruby.includes(search)) {
                        matchSearch = true;
                    }
                }

                if (searchType && !matchSearch) {
                    const tribe = (card.tribe || '').toLowerCase();
                    const monsterType = (card.monsterType || '').toLowerCase();
                    const monsterTypeText = (card.monsterTypeText || '').toLowerCase();
                    if (tribe.includes(search) || monsterType.includes(search) || monsterTypeText.includes(search)) {
                        matchSearch = true;
                    }
                }

                if (searchContent && !matchSearch) {
                    const supplementText = (card.supplementText || '').toLowerCase();
                    const contentText = (card.contentText || '').toLowerCase();
                    
                    const skillTexts = (card.skills || []).map(s => 
                        ((s.name || '') + ' ' + (s.text || '')).toLowerCase()
                    ).join(' ');

                    if (supplementText.includes(search) || contentText.includes(search) || skillTexts.includes(search)) {
                        matchSearch = true;
                    }
                }

                return matchFilter && matchSearch;
            });

            filteredCards.sort((a, b) => {
                switch(sort) {
                    case 'name': return a.cardName.localeCompare(b.cardName);
                    case 'type': return a.cardBase.localeCompare(b.cardBase);
                    case 'atk': return (b.attack || 0) - (a.attack || 0);
                    case 'hp': return (b.hp || 0) - (a.hp || 0);
                    case 'cost': return ( (a.magicCost||0) - (b.magicCost||0) ); // é­”æ³•: ã‚³ã‚¹ãƒˆæ˜‡é †
                    default: return 0;
                }
            });

            updateStats();
            document.getElementById('displayCards').textContent = filteredCards.length;
            renderCards();
        }

        function updateStats() {
            document.getElementById('totalCards').textContent = allCards.length;
            document.getElementById('displayCards').textContent = filteredCards.length;
            document.getElementById('monsterCount').textContent = allCards.filter(c => c.cardBase === 'monster' || c.cardBase === 'ex').length;
            document.getElementById('magicCount').textContent = allCards.filter(c => c.cardBase === 'magic').length;
            document.getElementById('supporterCount').textContent = allCards.filter(c => c.cardBase === 'supporter').length;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã®å®‰å…¨åŒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ï¼‰
        function sanitizeFileName(name) {
            if (!name) return '';
            const s = String(name).replace(/[<>:"\/\\|?*\x00-\x1F]/g, '').trim();
            return s.replace(/\s+/g, '_');
        }

        function renderCards() {
            const container = document.getElementById('cardContainer');
 
            // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (viewMode === 'simple') {
                container.classList.add('simple-mode');
            } else {
                container.classList.remove('simple-mode');
            }
 
            // sanitizeFileName ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨
             if (filteredCards.length === 0) {
                 container.innerHTML = `
                     <div class="empty-state">
                         <div class="empty-state-icon">ğŸ”</div>
                         <h3>ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
                         <p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’èª¿æ•´ã—ã¦ãã ã•ã„</p>
                     </div>
                 `;
                 return;
             }
 
             container.innerHTML = filteredCards.map(card => {
                 const typeClass = `type-${card.cardBase}`;
                 const typeName = {
                     monster: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼',
                     magic: 'é­”æ³•',
                     supporter: 'ã‚µãƒãƒ¼ã‚¿ãƒ¼',
                     ex: 'EX'
                 }[card.cardBase];
 
                 // è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã§ã¯ 'detail' ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
                 const modeClass = viewMode === 'simple' ? ' simple' : ' detail';
 
                 // ç”»åƒãƒ‘ã‚¹: cardimg/<sanitized cardName>.pngï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° cardimg/sumple.png ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                 const fileName = sanitizeFileName(card.cardName) || 'sumple';
                 const imgPath = `cardimg/${fileName}.png`;
 
                 let html = `<div class="card-item${modeClass}">`
                     + `<div class="card-header">
                         <div class="card-title-section">
                             <div class="card-name">${card.cardName || 'åå‰ãªã—'}</div>
                             ${card.cardRuby && viewMode === 'detail' ? `<div class="card-ruby">${card.cardRuby}</div>` : ''}
                         </div>
                         <div class="card-meta">
                             <span class="card-type ${typeClass}">${typeName}</span>`;
 
                 if (card.cardBase === 'monster' || card.cardBase === 'ex') {
                     html += `<div class="card-stats">
                         <span>âš”ï¸${card.attack}</span>
                         <span>â¤ï¸${card.hp}</span>
                         ${card.tribe ? `<span>ğŸ‘¥${card.tribe}</span>` : ''}
                         ${card.monsterTypeText && viewMode === 'simple' ? `<span>ğŸ·ï¸${card.monsterTypeText}</span>` : ''}
                     </div>`;
                 } else if (card.cardBase === 'magic') {
                     html += `<div class="card-stats"><span>ğŸ’${card.magicCost}</span></div>`;
                 }
 
                 html += `</div></div>`;
 
                 if (viewMode === 'detail') {
                     // ç”»åƒ + è©³ç´°ã‚’å·¦å³ä¸¦ã³ã§è¡¨ç¤º
                     html += `<div class="card-body"><div class="card-image"><img src="${imgPath}" alt="card image" onerror="this.onerror=null;this.src='cardimg/sumple.png'"></div><div class="card-details">`;
 
                     if (card.cardBase === 'monster' || card.cardBase === 'ex') {
                         // çŸ­ã„æƒ…å ±ã¯æ¨ªä¸¦ã³
                         html += `<div class="card-info-row">`;
                         
                         if (card.monsterType) {
                             html += `<div class="card-section">
                                 <div class="section-label">ç¨®åˆ¥:</div>
                                 <div class="section-content">${card.monsterType}ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</div>
                             </div>`;
                         }
 
                         if (card.tribe) {
                             html += `<div class="card-section">
                                 <div class="section-label">æ—:</div>
                                 <div class="section-content">${card.tribe}</div>
                             </div>`;
                         }
 
                         if (card.monsterTypeText) {
                             html += `<div class="card-section">
                                 <div class="section-label">ã‚¿ã‚¤ãƒ—:</div>
                                 <div class="section-content">${card.monsterTypeText}</div>
                             </div>`;
                         }
                         
                         html += `</div>`;
 
                         if (card.evolutionSource) {
                             html += `<div class="card-section full-width">
                                 <div class="section-label">é€²åŒ–å…ƒ</div>
                                 <div class="section-content">${card.evolutionSource}</div>
                             </div>`;
                         }
 
                         if (card.supplementText) {
                             html += `<div class="card-section full-width">
                                 <div class="section-label">è£œè¶³</div>
                                 <div class="section-content">${card.supplementText}</div>
                             </div>`;
                         }
 
                         if (card.skills && card.skills.length > 0) {
                             html += `<div class="card-section full-width">
                                 <div class="section-label">ã‚¹ã‚­ãƒ«</div>
                                 <div class="skill-list">`;
                             card.skills.forEach(skill => {
                                 html += `<div class="skill-item">
                                     <div class="skill-header">${skill.type}: ${skill.name}</div>
                                     ${skill.text ? `<div class="skill-text">${skill.text}</div>` : ''}
                                 </div>`;
                             });
                             html += `</div></div>`;
                         }
                     }
 
                     if (card.contentText) {
                         html += `<div class="card-section full-width">
                             <div class="section-label">åŠ¹æœ</div>
                             <div class="section-content">${card.contentText}</div>
                         </div>`;
                     }
 
                     html += `</div></div>`; // .card-details .card-body ã®é–‰ã˜
                 }
 
                 html += `</div>`;
                 return html;
             }).join('');
             // è¡¨ç¤ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰è¦ç´ ã«ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’ä»˜ä¸ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ filteredCards é †ï¼‰
             container.querySelectorAll('.card-item').forEach((el, i) => {
                 el.addEventListener('click', () => showModal(i));
             });
         }

        function showModal(index) {
            const card = filteredCards[index];
            // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            document.getElementById('modalName').textContent = card.cardName || 'åå‰ãªã—';
            document.getElementById('modalRuby').textContent = card.cardRuby || '';
            document.getElementById('modalRuby').style.display = card.cardRuby ? 'block' : 'none';

            // ç”»åƒãƒ‘ã‚¹
            const fileName = sanitizeFileName(card.cardName) || 'sumple';
            const imgPath = `cardimg/${fileName}.png`;

            // è©³ç´°HTMLï¼ˆæ—¢å­˜ã® bodyHTML ã‚’æµç”¨ï¼‰
            let bodyHTML = '';
            const typeName = { monster: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', magic: 'é­”æ³•', supporter: 'ã‚µãƒãƒ¼ã‚¿ãƒ¼', ex: 'EX' }[card.cardBase];
            bodyHTML += `<div class="modal-section"><div class="modal-section-label">ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—</div><div class="modal-section-content">${typeName}</div></div>`;

            if (card.cardBase === 'monster' || card.cardBase === 'ex') {
                bodyHTML += `<div class="modal-section"><div class="modal-section-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div><div class="modal-info-row"><div class="modal-info-item"><span class="modal-section-label">ATK:</span><span class="modal-section-content">${card.attack}</span></div><div class="modal-info-item"><span class="modal-section-label">HP:</span><span class="modal-section-content">${card.hp}</span></div></div></div>`;
                if (card.monsterType || card.tribe || card.monsterTypeText) {
                    bodyHTML += `<div class="modal-section"><div class="modal-section-label">åˆ†é¡</div><div class="modal-info-row">`;
                    if (card.monsterType) bodyHTML += `<div class="modal-info-item"><span class="modal-section-label">ç¨®åˆ¥:</span><span class="modal-section-content">${card.monsterType}ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</span></div>`;
                    if (card.tribe) bodyHTML += `<div class="modal-info-item"><span class="modal-section-label">æ—:</span><span class="modal-section-content">${card.tribe}</span></div>`;
                    if (card.monsterTypeText) bodyHTML += `<div class="modal-info-item"><span class="modal-section-label">ã‚¿ã‚¤ãƒ—:</span><span class="modal-section-content">${card.monsterTypeText}</span></div>`;
                    bodyHTML += `</div></div>`;
                }
                if (card.evolutionSource) bodyHTML += `<div class="modal-section"><div class="modal-section-label">é€²åŒ–å…ƒ</div><div class="modal-section-content">${card.evolutionSource}</div></div>`;
                if (card.supplementText) bodyHTML += `<div class="modal-section"><div class="modal-section-label">è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆ</div><div class="modal-section-content">${card.supplementText}</div></div>`;
                if (card.skills && card.skills.length > 0) {
                    bodyHTML += `<div class="modal-section"><div class="modal-section-label">ã‚¹ã‚­ãƒ«</div><div class="modal-skills">`;
                    card.skills.forEach(skill => {
                        bodyHTML += `<div class="modal-skill-item"><div class="modal-skill-name">${skill.type}: ${skill.name}</div>${skill.text ? `<div class="modal-skill-text">${skill.text}</div>` : ''}</div>`;
                    });
                    bodyHTML += `</div></div>`;
                }
            }
            if (card.cardBase === 'magic') bodyHTML += `<div class="modal-section"><div class="modal-section-label">ã‚³ã‚¹ãƒˆ</div><div class="modal-section-content">ğŸ’ ${card.magicCost}</div></div>`;
            if (card.contentText) bodyHTML += `<div class="modal-section"><div class="modal-section-label">åŠ¹æœ</div><div class="modal-section-content">${card.contentText}</div></div>`;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `<div class="modal-image"><img src="${imgPath}" alt="card image" onerror="this.onerror=null;this.src='cardimg/sumple.png'"></div><div class="modal-details">${bodyHTML}</div>`;
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('detailModal').classList.remove('active');
        }

        autoLoadLocalJson();
    </script>
</body>
</html>